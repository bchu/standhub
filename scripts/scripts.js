"use strict";angular.module("standhubApp",["firebase","ui.bootstrap","ui.select2","angularMoment"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("standhubApp").factory("Data",["angularFire","angularFireCollection","$rootScope","$timeout",function(a,b,c){var d={};d.fireUrl="https://standhubdev.firebaseio.com/",d.user,d.userRef,d.userUrl=d.fireUrl+"users/";var e=new Firebase(d.userUrl);return d.users=b(d.userUrl),d.requestsUrl=d.fireUrl+"requests/",d.requests=b(d.requestsUrl),new Firebase(d.requestsUrl),d.addRequest=function(a){a.from=d.user.id,a.utc_timestamp=(new Date).getTime();var b={},c=0;_.each(d.users,function(e){return _.contains(e.tags,a.tag)&&e.id!==d.user.id&&(b[e.id]="pending",c++),c>=3?!1:void 0}),a.targets=b,d.requests.add(a)},d.requestsFromYou=[],d.requestsToYou=[],d.refreshRequestsRef=new Firebase(d.requestsUrl),d.refreshRequests=function(){console.log("refresh requests"),d.requestsFromYou=[],d.requestsToYou=[],d.refreshRequestsRef.off(),d.refreshRequestsRef=new Firebase(d.requestsUrl),d.refreshRequestsRef.on("child_added",function(a){if(console.log("fired!!!!"),d.user){var b=a.val();b.refName=a.name(),b.targets&&"string"==typeof b.targets[d.user.id]&&b.from!==d.user.id&&"decline"!==b.targets[d.user.id]&&d.requestsToYou.push(b),b.from===d.user.id&&d.requestsFromYou.push(b)}}),d.refreshRequestsRef.on("child_changed",function(a){for(var b=a.name(),c=d.requestsFromYou.length-1;c>=0;c--)d.requestsFromYou[c].refName===b&&(d.requestsFromYou[c].targets=a.val().targets);for(var c=d.requestsToYou.length-1;c>=0;c--)d.requestsToYou[c].refName===b&&(d.requestsToYou[c].targets=a.val().targets,"decline"===a.val().targets[d.user.id]&&d.requestsToYou.splice(c,1))}),d.refreshRequestsRef.on("child_removed",function(a){for(var b=a.name(),c=d.requestsFromYou.length-1;c>=0;c--)d.requestsFromYou[c].refName===b&&d.requestsFromYou.splice(c,1);for(var c=d.requestsToYou.length-1;c>=0;c--)d.requestsToYou[c].refName===b&&d.requestsToYou.splice(c,1)})},d.userFromId=function(a){for(var b=0;b<d.users.length;b++)if(a===d.users[b].id)return d.users[b];return!1},d.authClient=new FirebaseAuthClient(new Firebase(d.fireUrl),function(a,b){if(a)console.log(a);else if(b){d.user=b;var f=d.userFromId(b.id),g=function(){d.user=f,d.userUrl+=f.id,d.userRef=new Firebase(d.userUrl),c.$apply(),d.refreshRequests()};f?g():e.child(b.id).transaction(function(a){a=a||{};var c=_.assign(a,b);return c},function(){f=d.userFromId(b.id),g()})}else d.user=void 0,d.userRef=void 0,d.userUrl=d.fireUrl+"users/",d.requestsFromYou=[],d.requestsToYou=[]}),d}]),angular.module("standhubApp").controller("MainCtrl",["$scope","Data",function(){}]),angular.module("standhubApp").controller("LoginCtrl",["$scope","Data",function(a,b){a.loggedIn=!1,a.$watchCollection(function(){return b.user},function(b){if(a.user=b,b){var c=[];_.each(b.tags,function(a){c.push({id:a,text:a})}),a.tags=c,a.loggedIn=!0}}),a.tagOptions={tags:["AngularJS","JavaScript","Objective-C","iOS","Unix","Pitch decks"],tokenSeparators:[",",";"],initSelection:function(b,c){c(a.tags)}},a.facebookLogin=function(){b.authClient.login("facebook",{rememberMe:!0}),a.loggedIn="pending"},a.addTags=function(a){a&&(a=_.pluck(a,"text"),b.userRef.child("tags").set(a))},a.logout=function(){b.authClient.logout(),a.loggedIn=!1,a.tags=[]},a.opts={backdropFade:!0,dialogFade:!0},a.open=function(){a.shouldBeOpen=!0},a.close=function(){a.shouldBeOpen=!1}}]),angular.module("standhubApp").controller("HelpCtrl",["$scope","Data",function(a,b){a.tagOptions={tags:["AngularJS","JavaScript","Objective-C","iOS","Unix","Pitch decks"],tokenSeparators:[",",";"],maximumSelectionSize:1},a.submitRequest=function(c,d){var e=c[0]&&c[0].text||"";b.addRequest({tag:e,comment:d||""}),a.tags=null,a.comment=null}}]),angular.module("standhubApp").controller("StatusCtrl",["$scope","Data",function(a,b){a.userStatus="",a.submitStatus=function(c){b.userRef&&(b.userRef.child("status").set(c),b.userRef.child("timestamp").set(new Date)),a.close()},a.opts={backdropFade:!0,dialogFade:!0},a.open=function(){a.shouldBeOpen=!0},a.close=function(){a.shouldBeOpen&&(a.shouldBeOpen=!1)}}]),angular.module("standhubApp").controller("StatusesCtrl",["$scope","Data",function(a,b){a.users=b.users,a.$watchCollection(function(){return b.users},function(b){a.users=b})}]),angular.module("standhubApp").controller("AlertsCtrl",["$scope","Data","$timeout",function(a,b){a.$watch(function(){return b.requestsToYou},function(b){a.requestsToYou=b},!0),a.$watch(function(){return b.requestsFromYou},function(b){a.requestsFromYou=b},!0),a.accept=function(a){var c=b.requestsUrl+a.refName+"/targets/",d=new Firebase(c).child(b.user.id);d.set("accept",function(){})},a.decline=function(a){var c=b.requestsUrl+a.refName+"/targets/",d=new Firebase(c).child(b.user.id);d.set("decline",function(){})},a.cancel=function(a){var c=b.requestsUrl+a.refName,d=new Firebase(c);d.remove(function(){})}}]),angular.module("standhubApp").filter("username",["Data",function(a){return function(b){for(var c=0;c<a.users.length;c++){var d=a.users[c];if(d.id===b)return d.name}}}]);